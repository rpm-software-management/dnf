# dnf completion                                          -*- shell-script -*-
#
# This file is part of dnf.
#
# Copyright 2013 (C) Elad Alfassa <elad@fedoraproject.org>
# Copyright 2014-2015 (C) Igor Gnatenko <i.gnatenko.brain@gmail.com>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
# 02110-1301  USA

__dnf_main_options="
    -4 -6 -b -c -C -d -e -h -q -R -v -x -y
    --advisory --advisories
    --allowerasing --assumeno
    --assumeyes
    --best --bugfix
    --bz
    --cacheonly --config
    --color --cve
    --debuglevel --debugsolver
    --disableexcludes --disableplugin
    --disableexcludepkgs --disablerepo
    --downloadonly --destdir
    --downloaddir
    --errorlevel --enableplugin
    --enablerepo --enhancement
    --exclude --excludepkgs
    --help --help-cmd
    --installroot
    --newpackage --nodocs
    --nogpgcheck --noplugins
    --noautoremove
    --obsoletes
    --quiet
    --randomwait --refresh
    --releasever --repofrompath
    --repo --repoid
    --rpmverbosity
    --sec-severity --secseverity
    --security --setopt
    --skip-broken --showduplicates
    --verbose --version
"

__dnf_history_subcmds="info list redo rollback undo userinstalled"

__dnf_secseverity_subcmds='Critical Important Low Moderate'

__dnf_clean_subcmds="all dbcache expire-cache metadata packages"

__dnf_repoquery_subcmds="
    -a -f -i -l -s
    --all --arch
    --archlist --available
    --alldeps
    --conflicts
    --deplist --duplicates
    --exactdeps --extras
    --envra --enhances
    --file
    --groupmember
    --installed --installonly
    --info
    --latest-limit --list
    --location
    --nevra  --nvr
    --provides
    --qf --queryformat
    --querytags
    --recent --requires-pre
    --recommends --requires
    --recursive --resolve
    --source --suggests
    --supplements --show-duplicates
    --srpm
    --tree
    --upgrades --unneeded
    --unsatisfied --userinstalled
    --whatconflicts --whatobsoletes
    --whatprovides --whatrequires
    --whatrecommends --whatenhances
    --whatsuggests --whatsupplements
"

__dnf_repopkgs_subcmds="
    check-update
    info install
    list
    move-to
    remove-or-reinstall remove-or-distro-sync
    reinstall reinstall-old
    upgrade upgrade-to
"

__dnf_python_exec=
_dnf_set_python_exec()
{
    if [[ "$( readlink /usr/bin/dnf )" == "dnf-2" ]]; then
        __dnf_python_exec="/usr/bin/python2"
    else
        if [ -x /usr/libexec/platform-python ]; then
            __dnf_python_exec="/usr/libexec/platform-python"
        else
            __dnf_python_exec="/usr/bin/python3"
        fi
    fi
}

_dnf_commands_helper()
{
    local helper_cmd="import sys; from dnf.cli import completion_helper as ch; ch.main(sys.argv[1:])"
    local helper_opts="-d 0 -q -C --assumeno --nogpgcheck"
    echo "$( ${__dnf_python_exec} -c "$helper_cmd" "$@" $helper_opts 2>/dev/null </dev/null )"
}

_dnf_is_path()
{
    if [[ "$1" == \.* ]] || [[ "$1" == *\/* ]] || [[ "$1" == ~* ]]; then
        return 0
    else
        return 1
    fi
}

# executes SQL query and appends resulting records to COMPREPLY
# @param $1 sql query
_dnf_completion_cache()
{
    [[ -z $1 ]] && return 1
    local cache_file="/var/cache/dnf/packages.db"
    local sqlite3="sqlite3 -batch -init /dev/null"
    local result
    if result=( $( $sqlite3 $cache_file "$1" 2>/dev/null ) ); then
        COMPREPLY+=( $( compgen -W '${result[@]}' ) )
        return 0
    else
        return 1
    fi
}


# @param $1 sql query for generating results from cache
# @param $2 command
_dnf_show_packages()
{
    local query="$1" cmd=$2

    # return when "-" follows command
    # eg.: dnf up -
    [[ "$cur" == -* ]] && return

    shift 2

    if ! _dnf_is_path "$cur"; then
        if ! _dnf_completion_cache "$query"; then
            COMPREPLY+=( $(compgen -W "$( _dnf_commands_helper $cmd "$@" "$cur" )") )
        fi
    fi
}

_dnf_get_first_command()
{
    local cmd i

    for (( i=1; i < ${#COMP_WORDS[@]}; i++ )); do
        if [[ "$1"  == *${COMP_WORDS[i]}* ]]; then
            cmd=${COMP_WORDS[i]}
            break
        fi
    done

    echo "$cmd"
}

_dnf()
{
    _dnf_set_python_exec

    local complete_commands complete_options extra_options command cmd_list
    local cur prev words cword split
    _init_completion -s || return

    local query
    local query_installed="SELECT pkg FROM installed WHERE pkg LIKE \"$cur%\""
    local query_available="SELECT pkg FROM available WHERE pkg LIKE \"$cur%\""

    cmd_list="$( _dnf_commands_helper "_cmds" "" )"
    command="$( _dnf_get_first_command "$cmd_list" )"

    case $prev in
    --version)
       return ;;

    -h|--help|--help-cmd)
        [[ $cword -eq 3 ]] && return ;;

    -d|--debuglevel|-e|--errorlevel)
        COMPREPLY=( $( compgen -W '0 1 2 3 4 5 6 7 8 9 10' -- "$cur" ) )
        return
        ;;

    --installroot)
        _filedir -d
        return ;;

    --enablerepo)
        COMPREPLY=( $(compgen -W "$( _dnf_commands_helper repolist disabled "$cur" )" -- "$cur") )
        return ;;

    --disablerepo)
        COMPREPLY=( $(compgen -W "$( _dnf_commands_helper repolist enabled "$cur" )" -- "$cur") )
        return ;;

    --color)
        COMPREPLY=( $(compgen -W "yes no true false 0 1" -- "$cur" ) )
        return ;;

    --destdir|--downloaddir)
        _filedir -d
        return ;;

    --sec*severity)
        COMPREPLY=( $( compgen -W "$__dnf_secseverity_subcmds" -- "$cur" ) )
        return ;;
    *)
        ;;
    esac

    complete_commands=

    case "$command" in
    autoremove|autoremove-n*)
        _dnf_show_packages "$query_installed" list installed
        ;;

    check)
        extra_options="--all --dependencies --duplicates --obsoleted --provides"
        complete_commands="all dependencies duplicates obsoleted provides"
        ;;

    check-update|check-upgrade)
        _dnf_show_packages "" list updates
        ;;

    clean)
        complete_commands="$__dnf_clean_subcmds"
        ;;

    dist-upgrade|dsync|distro*sync|distribution-synchronization)
        _dnf_show_packages "$query_installed" list installed
        ;;

    downgrade)
        _dnf_show_packages "$query_installed" $command
        ;;

    group|groups|grouperase|groupinfo|groupinstall|grouplist|groupremove|groupupdate)
        extra_options="--with-optional --hidden --installed --available"
        ;;

    help)
        [[ $cword -eq 3 ]] && return 0
        complete_commands="$cmd_list"
        ;;

    history)
        complete_commands="$__dnf_history_subcmds"
        ;;

    info|list)
        local subcmd="available installed updates upgrades
                      --available --installed --updates --upgrades"
        case "$( _dnf_get_first_command "$subcmd" )" in
            --installed|installed)
                _dnf_show_packages "$query_installed" list installed ;;

            --available|available)
                _dnf_show_packages "$query_available" list available ;;

            --updates|--upgrades|updates|upgrades)
                _dnf_show_packages "" list updates ;;

            *)
                _dnf_show_packages "$query_available" list
            ;;

        esac

        extra_options="--all --available --installed --extras --updates
                       --upgrades --autoremove --recent"
        ;;

    info-*|list-*|updateinfo|summary-updateinfo)
        extra_options="--summary --list --info"
        complete_commands="summary list info"
        ;;

    in|install*|localinstall)
        COMPREPLY=( $(compgen -o default -f -X "!*.@(rpm)" -- "$cur" ) )
        query="SELECT available.pkg FROM available LEFT JOIN installed USING(pkg) WHERE available.pkg LIKE \"$cur%\" AND installed.pkg IS NULL"
        _dnf_show_packages "$query" $command
        ;;

    mark)
        _dnf_show_packages "$query_installed" list installed
        ;;

    makecache|refresh)
        [[ "$prev" == *"timer" ]] && return
        extra_options="--timer"
        complete_commands="timer"
        ;;

    provides)
        ;;

    reinstall)
        _dnf_show_packages "$query_installed" $command
        ;;

    remove*|erase*)
        _dnf_show_packages "$query_installed" $command
        extra_options="--oldinstallonly --duplicates --duplicated"
        ;;

    repoinfo|repolist)
        extra_options="--all --enabled --disabled"
        case $prev in
        enabled|--enabled)
            complete_commands="$( _dnf_commands_helper $command enabled "$cur" )"
            ;;
        disabled|--disabled)
            complete_commands="$( _dnf_commands_helper $command disabled "$cur" )"
            ;;
        all|--all|*)
            complete_commands="$( _dnf_commands_helper $command all "$cur" )"
        esac
        ;;

    repoquery*)
        extra_options="$__dnf_repoquery_subcmds"
        ;;

    repo*-pkgs|repo*-packages)
        complete_commands="$__dnf_repopkgs_subcmds"
        ;;

    search)
        [[ "$prev" == *"all" ]] && return
        extra_options="--all"
        complete_commands="all"
        ;;

    shell) ;;

    swap) ;;

    upgrade|upgrade-n*)
        _dnf_show_packages "$query_available" $command
        ;;

    update|update-n*)
        _dnf_show_packages "$query_available" $command
        ;;

    whatprovides) ;;

    *)
        complete_commands="$cmd_list"
        ;;
    esac

    $split && return

    case $cur in
    -*)
        complete_options="$__dnf_main_options $extra_options"
        COMPREPLY=( $(compgen -W "$complete_options" -- "$cur" ))
        ;;
    *)
        if [[ $cur == $command ]]; then
            complete_commands="$cmd_list"
        fi

        if [[ "$complete_commands" ]]; then
            COMPREPLY=( $(compgen -W "$complete_commands" -- "$cur" ))
        fi
    esac

    [[ $COMPREPLY == *= ]] && compopt -o nospace
    return 0
} &&
complete -F _dnf dnf dnf-2 dnf-3
